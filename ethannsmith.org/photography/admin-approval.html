<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Approval</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<style>
body { font-family: Arial, sans-serif; background:#f9f9f9; padding:2rem; }
h1 { margin-bottom:1rem; }
.account { background:#fff; padding:1rem; margin-bottom:1.5rem; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
button { margin-right:0.5rem; padding:0.5rem 1rem; border:none; border-radius:6px; cursor:pointer; font-weight:bold; }
.approve { background: #2c7a2c; color:white; }
.deny { background: #b02d2d; color:white; }
.reason-box { margin-top:0.5rem; }
.reason-box textarea { width:100%; height:60px; margin-top:0.5rem; padding:0.5rem; border-radius:6px; border:1px solid #ccc; }

.gauge { margin-top:0.4rem; background:#eee; border-radius:10px; height:12px; overflow:hidden; }
.gauge-fill { height:100%; transition: width 0.4s ease; }
.gauge-label { font-size:0.85rem; margin:0.3rem 0; display:flex; align-items:center; gap:6px; }
.gauge-label i { font-size:14px; }
</style>
</head>
<body>
<h1><i class="fas fa-user-shield"></i> Accounts Awaiting Approval</h1>
<div id="accounts"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, getDocs, updateDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// ✅ Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDZjXZtfqEscgVBYOYDZS-vRwxBuXuVsbQ",
  authDomain: "email-list-83dfb.firebaseapp.com",
  projectId: "email-list-83dfb",
  storageBucket: "email-list-83dfb.appspot.com",
  messagingSenderId: "471452404510",
  appId: "1:471452404510:web:e91752174f6f0000c1570f"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ✅ EmailJS
emailjs.init("hYbb_OOgMoLQEqodi"); // replace with your PUBLIC KEY

function sendEmail({to_email, status, status_class, message, reason}) {
  // professional HTML template
  const htmlTemplate = `
  <div style="font-family:Arial,sans-serif;max-width:600px;margin:auto;background:#fff;border-radius:10px;overflow:hidden;box-shadow:0 4px 10px rgba(0,0,0,0.1)">
    <div style="background:${status_class === "approved" ? "#2c7a2c" : "#b02d2d"};color:#fff;padding:15px 20px;font-size:18px;font-weight:bold;">
      <i class="fas ${status_class === "approved" ? "fa-check-circle" : "fa-times-circle"}"></i>
      Account ${status}
    </div>
    <div style="padding:20px;color:#333;line-height:1.6;">
      <p>Dear user,</p>
      <p>${message}</p>
      ${reason ? `<p><b>Reason:</b> ${reason}</p>` : ""}
      <p style="margin-top:20px;">Best regards,<br><b>The Admin Team</b></p>
    </div>
    <div style="background:#f5f5f5;text-align:center;padding:10px;font-size:12px;color:#777;">
      This is an automated message. Please do not reply directly.
    </div>
  </div>`;

  return emailjs.send("service_6ahizcg", "template_1hcq7qq", {
    to_email,
    status,
    status_class,
    message,
    reason,
    html_message: htmlTemplate
  })
  .then(() => console.log("✅ Email sent to", to_email))
  .catch(err => console.error("❌ Email error:", err));
}

// 🔹 Gauges
function passwordStrength(password){
  let score = 0;
  if(password.length >= 8) score++;
  if(/[A-Z]/.test(password)) score++;
  if(/[0-9]/.test(password)) score++;
  if(/[^A-Za-z0-9]/.test(password)) score++;
  return (score / 4) * 100;
}
function emailLikelihood(email){
  const commonDomains = ["gmail.com","yahoo.com","outlook.com","hotmail.com"];
  if(!/^[^@]+@[^@]+\.[^@]+$/.test(email)) return 10;
  const domain = email.split("@")[1];
  return commonDomains.includes(domain) ? 90 : 60;
}
function makeGauge(label, icon, value){
  let color = value < 40 ? "#d9534f" : value < 70 ? "#f0ad4e" : "#5cb85c";
  return `
    <div class="gauge-label"><i class="fas fa-${icon}"></i> ${label}: ${value}%</div>
    <div class="gauge"><div class="gauge-fill" style="width:${value}%; background:${color}"></div></div>
  `;
}

// 🔄 Load accounts
async function loadAccounts(){
  const container = document.getElementById("accounts");
  container.innerHTML = "";
  const snap = await getDocs(collection(db, "accounts"));
  snap.forEach(acc => {
    const data = acc.data();
    if(data.approvalStatus === "pending"){
      const pwdScore = passwordStrength(data.password);
      const emailScore = emailLikelihood(data.email);

      const div = document.createElement("div");
      div.className="account";
      div.innerHTML = `
        <p><b>Email:</b> ${data.email}</p>
        <p><b>Auth:</b> ${data.auth}</p>
        <p><b>Password:</b> ${data.password}</p>
        ${makeGauge("Password Strength", "key", pwdScore)}
        ${makeGauge("Email Likelihood", "envelope", emailScore)}
        <button class="approve"><i class="fas fa-check"></i> Approve</button>
        <button class="deny"><i class="fas fa-times"></i> Deny</button>
        <div class="reason-box" style="display:none;">
          <textarea placeholder="Reason for denial..."></textarea>
          <button class="confirm-deny"><i class="fas fa-paper-plane"></i> Send Denial</button>
        </div>
      `;

      // ✅ Approve
      div.querySelector(".approve").onclick = async ()=>{
        await updateDoc(doc(db,"accounts",acc.id), { approvalStatus:"approved" });
        await sendEmail({
            to_email: data.email,
  status: "Approved",
  message: "Congratulations! Your account has been approved 🎉 You can now log in.",
  reason: "None",
  header_color: "#2c7a2c",        // green
  icon_class: "fas fa-check-circle"
        });
        loadAccounts();
      };

      // 🚫 Deny
      div.querySelector(".deny").onclick = ()=>{
        div.querySelector(".reason-box").style.display="block";
      };
      div.querySelector(".confirm-deny").onclick = async ()=>{
        const reason = div.querySelector("textarea").value || "No reason provided.";
        await deleteDoc(doc(db,"accounts",acc.id));
        await sendEmail({
          to_email: data.email,
  status: "Denied",
  message: "Unfortunately, your account has been denied.",
  reason: "Password too weak.",
  header_color: "#b02d2d",        // red
  icon_class: "fas fa-times-circle"
        });
        loadAccounts();
      };

      container.appendChild(div);
    }
  });
}
loadAccounts();
</script>
</body>
</html>
