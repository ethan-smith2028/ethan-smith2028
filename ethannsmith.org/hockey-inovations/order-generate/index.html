<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Order Tracker</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js"></script>
  <style>
    :root {
      --primary: #4f46e5;
      --bg: #f3f4f6;
      --card: #fff;
      --text: #111827;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      --radius: 12px;
    }
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 2rem;
      background: var(--bg);
      color: var(--text);

      /* Header */
header {
  background: transparent;
  color: white;
  padding: 1rem 0;
  text-align: center;
}

header img {
  height: 60px;
}

.menu {
  margin-top: 1rem;
  display: flex;
  justify-content: center;
  gap: 1rem;
  flex-wrap: wrap;
}

.menu button {
  background: var(--primary);       /* transparent background */
  border: 2px solid white;
  color: white;
  padding: 0.5rem 1rem;
  font-weight: bold;
  border-radius: 6px;
  cursor: pointer;
  transition: 0.3s ease;
}

.menu button.active {
  background: white;             /* filled background */
  color: #111;                   /* dark text */
  border-color: white;           /* keep border same or remove if you want */
}
    }
    .container {
      max-width: 900px;
      margin: auto;
    }
    .card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 2rem;
      box-shadow: var(--shadow);
      margin-bottom: 2rem;
    }
    h2 {
      margin-top: 0;
    }
    button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 8px;
      margin: 0.3rem 0.3rem 0.3rem 0;
      cursor: pointer;
    }
    button:hover {
      background: #3730a3;
    }
    .order-link {
      color: var(--primary);
      word-break: break-word;
    }
    .update-buttons i {
      margin-right: 0.5rem;
    }
    .order-list {
      margin-top: 2rem;
    }
    ul#savedOrdersList li {
      margin-bottom: 0.5rem;
    }
    .timeline,
    #statusList,
    #publicStatusList {
      position: relative;
      padding-left: 2rem;
      list-style: none;
      border-left: 2px solid #d1d5db;
      margin-top: 1rem;
    }
    .timeline li,
    #statusList li,
    #publicStatusList li {
      position: relative;
      margin-bottom: 2rem;
      padding-left: 2.5rem;
    }
    .timeline li::before,
    #statusList li::before,
    #publicStatusList li::before {
      content: '';
      position: absolute;
      top: 0.5rem;
      left: -10px;
      width: 12px;
      height: 12px;
      background-color: var(--primary);
      border: 2px solid white;
      border-radius: 50%;
      z-index: 1;
    }
    .timeline li::before,
#statusList li::before,
#publicStatusList li::before {
  display: none;
}

    .timeline i.fa-solid,
    #statusList i.fa-solid,
    #publicStatusList i.fa-solid {
      position: absolute;
      left: -1.8rem;
      top: 0.1rem;
      font-size: 1rem;
      background: white;
      padding: 2px;
      border-radius: 50%;
      color: var(--primary);
      z-index: 2;
    }

    
  </style>
</head>

    <header>
            <div class="menu">
          <button onclick="window.location.href='index.html'">Return to Home</button>
            </div>
          </header>
<body>
  <!-- === Business Settings ============================================= -->
<div class="card" id="bizSettings">
  <h2>Your Business Info</h2>

  <input id="bizName"  placeholder="Business / Store Name"  style="width:100%;padding:.5rem;margin:.3rem 0;">
  <input id="bizEmail" placeholder="Business Email"         style="width:100%;padding:.5rem;margin:.3rem 0;">
  <input id="bizPhone" placeholder="Phone"                  style="width:100%;padding:.5rem;margin:.3rem 0;">
  <textarea id="bizAddress" rows="2" placeholder="Address"  style="width:100%;padding:.5rem;margin:.3rem 0;"></textarea>

  <button onclick="saveBizInfo()">Save Info</button>
  <span id="bizSaved" style="margin-left:.5rem;color:var(--primary);display:none;">Saved ✓</span>
</div>
<!-- =================================================================== -->

  <div class="container">
    <div class="card">
      <h2>Create New Order</h2>
      <div class="form-fields">
  <input type="email" id="customerEmail" placeholder="Customer Email" style="padding: 0.5rem; margin: 0.3rem 0; width: 100%; border-radius: 6px; border: 1px solid #ccc;">
  <textarea id="customerAddress" placeholder="Shipping Address" style="padding: 0.5rem; margin: 0.3rem 0; width: 100%; border-radius: 6px; border: 1px solid #ccc;"></textarea>
</div>

      <button onclick="createOrder()"><i class="fa-solid fa-plus"></i> Generate Order</button>
      <p id="orderCreated"></p>
    </div>

    <div class="card order-status" style="display:none;">
      <h2>Order Status</h2>
      <p><strong>Order ID:</strong> <span id="orderId"></span></p>
      <p><strong>Tracking Link:</strong> <a class="order-link" id="orderLink" target="_blank"></a></p>
      <div class="status-update">
        <h3>Progress Updates</h3>
        <ul class="timeline" id="statusList"></ul>
        <div class="update-buttons">
          <button onclick="addStatus('Order Received')"><i class="fa-solid fa-inbox"></i> Order Received</button>
          <button onclick="addStatus('Product Made')"><i class="fa-solid fa-cogs"></i> Product Made</button>
          <button onclick="addStatus('Packaged')"><i class="fa-solid fa-box"></i> Packaged</button>
          <button onclick="addStatus('Shipped')"><i class="fa-solid fa-truck"></i> Shipped</button>
          <button onclick="addStatus('Delivered')"><i class="fa-solid fa-check"></i> Delivered</button>
        </div>
        <hr style="margin:1.5rem 0;">
<button onclick="generateReceiptPDF()" style="background:#10b981;">
  <i class="fa-solid fa-file-pdf"></i> Generate Receipt PDF
</button>
<a id="pdfLink" style="display:none;margin-left:1rem;color:var(--primary);" target="_blank">View / Download PDF ↗</a>

      </div>
    </div>

    <div class="card order-list">
      <h2>Saved Orders</h2>
      <ul id="savedOrdersList"></ul>
    </div>
  </div>

 <script type="text/javascript" src="https://cdn.emailjs.com/dist/email.min.js?version=3.11.0"></script>

<script type="text/javascript"
        src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js">
</script>
<script type="text/javascript">
   (function(){
      emailjs.init({
        publicKey: "gfyQUSMLIE0KLYUPm",
      });
   })();
</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
        integrity="sha512-AKSqO8bIpOqzvYk9p9gZz8VbW32x1X4sKpHa3WzH6Shy/j8X1xa2ILfAXfVl9Z/7CYL3B2NMw+PY4F7gmR9p1g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>


 <script type="module">
import { initializeApp }   from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc,
         collection, getDocs, onSnapshot   } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const { jsPDF } = window.jspdf;   /* jsPDF UMD export */

const firebaseConfig = {/* … unchanged … */};
initializeApp(firebaseConfig);
const db = getFirestore();

const statusFA  = { 'Order Received':'fa-inbox','Product Made':'fa-cogs','Packaged':'fa-box','Shipped':'fa-truck','Delivered':'fa-check' };
const statusImg = { /* your hosted PNGs – unchanged */ };

let currentOrderId = null;

/* ---------- Business-info helpers ---------------------------------- */

function loadBizInfo() {
  const saved = JSON.parse(localStorage.getItem('bizInfo')||'{}');
  ['bizName','bizEmail','bizPhone','bizAddress'].forEach(k=>{
    if(saved[k]) document.getElementById(k).value = saved[k];
  });
}
function saveBizInfo() {
  const bizInfo = {};
  ['bizName','bizEmail','bizPhone','bizAddress'].forEach(k=>{
    bizInfo[k] = document.getElementById(k).value.trim();
  });
  localStorage.setItem('bizInfo',JSON.stringify(bizInfo));
  document.getElementById('bizSaved').style.display = 'inline';
  setTimeout(()=>document.getElementById('bizSaved').style.display='none',2000);
}

/* ---------- Core order flows (create / status / list) -------------- */

const genId = ()=>'NMRK-'+Math.random().toString(36).substring(2,9).toUpperCase();

async function createOrder(){
  const id   = genId();
  const link = `${location.origin}/hockey-inovations/order-generate/view.html?orderId=${id}`;
  const newOrder = {
    id, link,
    email   : document.getElementById('customerEmail').value || null,
    address : document.getElementById('customerAddress').value|| null,
    updates : []
  };
  await setDoc(doc(db,'orders',id), newOrder);
  currentOrderId = id;
  showOrder(newOrder);
  document.getElementById('orderCreated').textContent = `Order created: ${id}`;
  loadAllOrders();
}

function showOrder(order){
  currentOrderId = order.id;
  document.querySelector('.order-status').style.display='block';
  document.getElementById('orderId').textContent = order.id;
  const l = document.getElementById('orderLink'); l.href = l.textContent = order.link;
  renderStatus(order);
}

async function addStatus(text){
  const ref = doc(db,'orders',currentOrderId);
  const order = (await getDoc(ref)).data();
  order.updates.push({ text,time:new Date().toLocaleString(), icon:statusFA[text]});
  await setDoc(ref,order);
  renderStatus(order);
}

/* ---------- PDF generation (3×6 inch) ------------------------------ */

function generateReceiptPDF(){
  if(!currentOrderId) return alert('No order selected.');
  const biz = JSON.parse(localStorage.getItem('bizInfo')||'{}');
  const orderEl = document.getElementById('orderId');
  const orderId = orderEl ? orderEl.textContent : currentOrderId;

  getDoc(doc(db,'orders',orderId)).then(snap=>{
    if(!snap.exists()) return alert('Order not found.');
    const data = snap.data();
    const docPDF = new jsPDF({ orientation:'portrait', unit:'pt', format:[216,432] }); // 3×6 inch

    /* ---- Receipt layout ------------------------------------------ */
    let y=24; const line=16, left=16, w=200;
    docPDF.setFont('helvetica','bold').setFontSize(12).text(biz.bizName||'[Your Business]',left,y); y+=line;
    docPDF.setFont('helvetica','normal').setFontSize(9);
    if(biz.bizAddress) { docPDF.text(biz.bizAddress,left,y,{maxWidth:w}); y+=line; }
    if(biz.bizPhone  ) { docPDF.text('Tel: '+biz.bizPhone,left,y); y+=line; }
    if(biz.bizEmail  ) { docPDF.text('Email: '+biz.bizEmail,left,y); y+=line+4; }

    docPDF.setFontSize(11).setFont('helvetica','bold').text('RECEIPT',left,y); y+=line;
    docPDF.setFont('helvetica','normal').setFontSize(9);
    docPDF.text(`Order #: ${data.id}`, left, y); y+=line;
    docPDF.text(`Date   : ${new Date().toLocaleDateString()}`, left, y); y+=line+4;

    if(data.address){
      docPDF.setFont('helvetica','bold').text('Ship To:',left,y); y+=line;
      docPDF.setFont('helvetica','normal');
      docPDF.text(data.address,left,y,{maxWidth:w}); y+=line*2;
    }

    docPDF.setFont('helvetica','bold').text('Status History',left,y); y+=line;
    docPDF.setFontSize(8).setFont('helvetica','normal');
    data.updates.slice().reverse().forEach(u=>{
      docPDF.text(`• ${u.text}  (${u.time})`,left+8,y,{maxWidth:w-8});
      y+=line;
    });

    /* ---- output -------------------------------------------------- */
    const fileName = `Receipt-${data.id}.pdf`;
    const pdfURL   = docPDF.output('bloburl');
    const pdfLink  = document.getElementById('pdfLink');
    pdfLink.href   = pdfURL;
    pdfLink.download = fileName;
    pdfLink.style.display='inline';
    pdfLink.textContent = 'View / Download PDF ↗';
  });
}

/* ---------- Firestore listing, on-load, etc. ----------------------- */

async function loadAllOrders(){
  const list = document.getElementById('savedOrdersList'); list.innerHTML='';
  (await getDocs(collection(db,'orders'))).forEach(d=>{
    const li=document.createElement('li');
    li.innerHTML=`<a class="order-link" href="?orderId=${d.id}">${d.id}</a>`;
    list.appendChild(li);
  });
}

window.saveBizInfo      = saveBizInfo;
window.createOrder      = createOrder;
window.addStatus        = addStatus;
window.generateReceiptPDF = generateReceiptPDF;

window.onload = async ()=>{
  loadBizInfo();
  const id=new URLSearchParams(location.search).get('orderId');
  id ? showOrder((await getDoc(doc(db,'orders',id))).data()) : loadAllOrders();
};
</script>


</body>
</html>
